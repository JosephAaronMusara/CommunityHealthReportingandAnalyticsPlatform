{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Health Reports</title>
    <link href="{% static 'css/localversionBootstrap.css' %}" rel="stylesheet">
    <script src="{% static 'js/slim.js' %}"></script>
    <script src="{% static 'js/localversionBootstrap.js' %}"></script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1>Health Reports</h1>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Incident Type</th>
                    <th>Location</th>
                    <th>Resolved</th>
                    <th>Verified</th>
                    <th>Date Reported</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td>{{ report.incident_type.name }}</td>
                    <td>{{ report.location.name }}</td>
                    <td>
                        <button class="btn btn-sm btn-toggle btn-outline-success" 
                                data-id="{{ report.id }}" 
                                data-field="resolved">
                            {% if report.resolved %}Mark as Unresolved{% else %}Mark as Resolved{% endif %}
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-toggle btn-outline-primary" 
                                data-id="{{ report.id }}" 
                                data-field="is_verified">
                            {% if report.is_verified %}Unverify{% else %}Verify{% endif %}
                        </button>
                    </td>
                    <td>{{ report.date_reported|date:"Y-m-d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No reports available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        document.querySelectorAll('.btn-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const reportId = this.dataset.id;
                const fieldName = this.dataset.field;
                fetch(`/report/toggle/${reportId}/${fieldName}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update button text based on new field value
                        this.textContent = data.new_value ? 
                            (fieldName === 'resolved' ? 'Mark as Unresolved' : 'Unverify') :
                            (fieldName === 'resolved' ? 'Mark as Resolved' : 'Verify');
                        // Optionally, update button style to reflect state change
                        this.classList.toggle('btn-outline-success', !data.new_value);
                        this.classList.toggle('btn-outline-danger', data.new_value);
                    } else {
                        alert("Error toggling report status");
                    }
                });
            });
        });
    </script>
</body>
</html>
